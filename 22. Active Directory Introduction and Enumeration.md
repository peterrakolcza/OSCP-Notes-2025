The AD enumeration is a crucial part to get the informations on what is running on the systems joined in the AD network, along with the users and groups. We can use basic .NET functions or directly, if we can download or transfer programs on the machine, use some automated tools.

# Nice to Know
## PowerView

PowerView is a very useful tool to enumerate many things in the windows machine and the domain. [Here](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993) there are some useful tricks with it.

## Swiss Army Knife: WADComs

[WADComs](https://wadcoms.github.io/) is a useful tool that gives you an overview of what you have and what you can do with the things that you have.

# CMD Commands

Active Directory stores information about objects on the network and makes this information easy for administrators and users to find and use. Active Directory uses a structured data store as the basis for a logical, hierarchical organization of directory information. List users in domain

```powershell
net user /domain
```

Enumerate user in domain

```powershell
net user <USER> /domain
```

List groups in domain

```powershell
net group /domain
```

Enumerate group in domain

```powershell
net group <GROUP> /domain
```

# PowerSploit

[PowerSploit](https://powersploit.readthedocs.io/en/latest/Recon/) is a useful tool that can be used to perform automatic enumeration. It has to be loaded in the system with

```powershell
powershell -ep bypass
Import-Module .\PowerSploit.ps1
```

Domain enumeration

```powershell
Get-NetDomain
```

User enumeration

```powershell
Get-NetUser
```

Groups enumeration

```powershell
Get-NetGroup
```

Get Access Control Entries

```powershell
Get-ObjectAcl -Identity <USERNAME>
```

Convert SID to name

```powershell
Convert-SidToName S-1-5-21-1987370270-658905905-1781884369-1104
```

Filter Identities for GenericAll ACL

```powershell
Get-ObjectAcl -Identity "Management Department" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier,ActiveDirectoryRights
```

Get-ObjectAcl -Identity stephanie

Enumerate object in the domain, selecting the operating system

```powershell
Get-NetComputer | select operatingsystem
```

To enumerate the machines in the domain with Admin access for our user

```powershell
Find-LocalAdminAccess
```

We can confirm it via

```powershell
Get-NetSession -ComputerName <COMPUTER-NAME>
```

Enumerate Service Principal Names

```powershell
Get-NetUser -SPN | select samaccountname,serviceprincipalname
```

Or with a builtin tool

```powershell
setspn -L <SERVICE-NAME>
```

# PsLoggedon

[PsLoggedon](https://learn.microsoft.com/it-it/sysinternals/downloads/psloggedon) is a useful tool that checks (if we have the right privileges) the other user sessions in the other systems of the domain.

```powershell
.\PsLoggedon.exe \\<COMPUTER-NAME>
```

# SharpHound and BloodHound

The [GitHub Link for BloodHound and SharpHound](https://github.com/BloodHoundAD/) utils are very useful in the AD enumeration for gathering informations about logged on users, and general data collection. `In order to perform succesful enumeration remember to download the right versions of the tools.` If we are using BloodHound v4.3.1 we must use the relative SharpHound v4.3.1, otherwise this will not work and the import of the audit.zip will be stuck at 0%. Under Collectors/SharpHound.ps1 we can find the correct version supported from the current BloodHound build.

## [SharpHound](https://github.com/BloodHoundAD/SharpHound)

SharpHound is used for the data collection part.

We first import it with

```powershell
Import-Module .\SharpHound.ps1
```

And we run the script, saving information in a ZIP file for easy transfer in our

```powershell
Invoke-BloodHound -CollectionMethod All -OutputDirectory <PATH> -OutputPrefix "audit"
```

For a SMB enumeration we can list the shares and check if we can access them

```powershell
Find-DomainShare
```

If in the sares we find some old credentials, encrypted with AES-256 we can decrypt it in the kali machine with

```powershell
gpp-decrypt <CREDENTIALS>
```

## [BloodHound](https://github.com/BloodHoundAD/BloodHound)

Is a useful graphical interface for printing the SharpHound retrieved data. It can print various information and make a diagram on what victim target first to gain AD Admin access. Here we can list users groups, sessions etc. The element displayed with the full SID are local object of the machines.

A useful RAW query to list all computer in a domain is the following

```
MATCH(m:Computer) RETURN m
```

To list all users

```
MATCH(m:User) RETURN m
```

Find active session for users and bind them to the computer

```
MATCH p = (c:Computer)-[:HasSession]->(m:User) RETURN p
```

Delete data from Neo4J

```
match (a) -[r] -> () delete a, r
match (a) delete a
```